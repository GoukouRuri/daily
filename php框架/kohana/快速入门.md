> ### Kohana3框架简单入门  -- 非官方版本

***

* 目录结构

  - 入口文件  index.php
  
    - 设置application,module,cache,log,system等路径
    
      - 根目录:  `../app`
      - 加载的应用配置文件  `../app/config/app.php`
      - 框架模块目录     `../../framework/modules`
      - 框架系统目录     `../../framework/system`
      - 缓存目录         `cache`
      - log目录          `logs`
      - 跨域设置
      - 加载引导文件bootstrap.php      `../app/bootstrap.php`  
      - 设置Error reporting的等级
      - 最后一段代码判断是php的运行模式是cgi还是fpm-fcgi模式,现在基本上都是后者,下面是index.php结束后进行路由分发
        
        ```php
         echo Request::factory(TRUE, array(), FALSE)    //生成实例
             ->execute()                                //执行,其中进行了分发,调用了controller
             ->send_headers(TRUE)                       //给定头部
             ->body();                                  //得到request的一些参数
        ```

> ### MVC结构

  - C层
  
    - application/app/classes/Controller/
    
    for example:
    
    创建控制器文件 `application/classes/Controller/Hello.php`,写入下面类似代码
    ```php
    
    <?php defined('SYSPATH') OR die('No Direct Script Access');   // 阻止直接从网址访问文件
    
    Class Controller_Hello extends Controller
    {
    
        public function before()
	    {
            // 每个方法前执行
        }
    
    	public function action_index()
    	{
    		// echo 'hello, world!';
		
		    // $id = $this->request->param("id");       // 接受请求参数,控制器绑定了Request请求处理类
                                                     
		    $view = View::factory('smarty:article');  // 定义哪个模板,并通过工厂模式生成
            $data = 'hello, world';
            $view->set('data', $data);    //为模板绑定数据
            $this->response->body($view); //加载这个模板
        
            // url跳转
            // $this->redirect('/article/index.html');
            
            // 操作配置项
            $source_url = Panshi::config("app.source_url"); //获取config/app.php文件里的source_url项
                 
            // 调用数据库操作
            $mode = new Model_Article();
            $ret = $mode->saveApply($data);
        
            
    	}
	    // 访问地址`http://myapp.com/index.php/hello/index`或者`http://myapp.com/hello/`
 
	    public function after()
        {
            // 每个方法后执行
        }
    }
    ```
    
  - V层
  
    - application/views/article.tpl
  
  - M层
  
    - application/app/classes/Model/
    
    - 数据库相关操作
    
      - 插入记录
      
        ```php
        // DB::insert() 方法插入数据成功则会返回array();key为insert_id, value为影响的行数
        // for example:
        <?php
        try {
            list ($id, $rows) = DB::insert('AUTHORIZATION', array_keys($data))->values(array_values($data))->execute();
            return $rows;
        } catch (Exception $e) {
            return 0;
        }

        ```  
    ***   
      - 读取记录
      
      ```php
      <?php
       // 返回一个结果对象
        $result = DB::select('column')->from('table_name')->execute();
       
        // 结果作为数组返回
        $result = DB::select('column')->from('table_name')->execute()->as_array();
       
        // 结果作为标准类对象返回
        $result = DB::select('column')->from('table_name')->as_object()->execute();
    
        // 仅返回第一行
        $result = DB::select('column')->from('table_name')->execute()->current();

        try {
            $user = DB::select()->from('users')
                      ->where('id','=', $this->request->param('id'))
                      ->execute()->current();
 
            echo Kohana::debug($user);
        } catch( Database_Exception $e ) {
            echo $e->getMessage();
        }
    
        // 字段别名,等价于SELECT `column` AS `my_column` FROM `table_name`;
    
        DB::select(array('column','my_column'))->from('table_name')->compile($db);
    
        // group by
    
        DB::select()->from('table_name')->group_by('column');
    
        // having
        DB::select()->from('table_name')->having('column','=','value');
    
        // and_having
    
        DB::select()->from('table_name')->having('column','=','value')->and_having('column2','=','value');
    
        // limit
        DB::select()->from('table_name')->limit(10);
    
        // offset
        DB::select()->from('table_name')->limit(10)->offset(50);
    
        // where
        DB::select()->from('table_name')->where('column','=','value');
    
        // and_where
    
        DB::select()->from('table_name')->where('column','=','value')->and_where('column2','=','value');
        
        // or_where
        DB::select()->from('table_name')->where('column','=','value')->or_where('column2','=','value');
    
        //...复杂的需要加括号的有whereopen, and_where_open, or_where_open
        DB::select()->from('table_name')->where('column','=','value')->and_where_open()->where('column2','=','value')
              ->or_where('column3','=','value')->and_where_close();

    
      ```
  
    *** 
    
      - 删除记录
      
      ```php
      <?php
  
      //删除数据库记录需要用到 DB::delete() 方法。这个请求的基本格式如下
      $total_rows = DB::delete('table_name')->where('column','=','value')->execute();
  
      try {
            $total_rows = DB::delete('users')->where('id','=',2)->execute();
        				
            echo Kohana::debug($total_rows);				
        		
      } catch( Database_Exception $e ) {
            echo $e->getMessage();
      }

      ```
    ***
    
      - 更新记录
      
       ```php
       <?php
       //更新数据库记录需要用到 DB::update() 方法.
       $total_rows = DB::update('table_name')->set(array('column'=>'value'))->where('column','=','value')->execute();
   
       try {
             $total_rows = DB::update('users')->set(array('username'=>'newuser'))
                     ->where('id','=',2)->execute();
         				
             echo Kohana::debug($total_rows);				
         		
       } catch( Database_Exception $e ) {
             echo $e->getMessage();
       }

       ``` 
    ***
       
      - 表达式
      
      ```php
      <?php
  
        //有些时候你想运行一个快速更新来使某列的数值增加，诸如一个视图或者列数。SQL 看起来就像这样
        //UPDATE `pages` SET `views` = views + 1 WHERE `id` = 1
        //假如是这样，我们能使用 DB::expr(‘’) 函数来创建表达式
          DB::update('pages')
          	 ->set(array('views' => DB::expr('views + 1')))
          	 ->where('id', '=', 1)
          	 ->execute();

    
      ```
       
    *** 
      - 事务
      
      ```php
      <?php
  
        DB::query(NULL, "BEGIN WORK")->execute();
       
        // 页面数据数组
        $page_data = array(
        	 'id'	 => NULL,
        	 'title'	 => 'My New Page',
        );
       
        $page = (bool) DB::insert('pages', array_keys($page_data))
        		 ->values($page_data)
        		 ->execute();
       
        $page_cat_data = array(
        	 'page_count'	 => DB::expr('page_count + 1'),
        );
       
        $page_cat = (bool) DB::update('page_categories')
        		 ->set($page_cat_data)
        		 ->where('id', '=', 1)
        		 ->execute();
       
        if($page AND $page_cat)
        {
        	 DB::query(NULL, "COMMIT")->execute();
        }
        else
        {
        	 DB::query(NULL, "ROLLBACK")->execute();
        }


      ```
      
    *** 
    
      - 联合查询
      
        ```php
        
        <?php
          // 例如要实现的sql是SELECT `articles`.`title`, `users`.`username` FROM `articles`JOIN `users` ON (`users`.`id` = `articles`.`user_id`) WHERE ` articles`.`id` = 1 LIMIT 1;

          // 写法
          $query = DB::select('articles.title', 'users.username')
          		 ->from('articles')
          		 ->where('articles.id', '=', 1)
          			 ->join('users')
          			 ->on('users.id', '=', 'articles.user_id')
          		 ->limit(1);


        ```
        
      
      
    

    
> 
  