> ### curl方法

* 简单的获取远程接口数据
```php
<?php
$ch = curl_init();  //创建了一个curl会话资源，成功返回一个句柄；
$url = "https://github.com/search?q=react";
curl_setopt($ch, CURLOPT_URL, $url);  //设置url

curl_setopt($ch, CURLOPT_RETURNTRANSFER, 0);  //设置是否将相应结果写入变量,0是直接echo出,1是存入 ,一般用1,不需要直接echo,存入变量就可以了

$output = curl_exec($ch);  //执行，然后将响应结果存入$output变量，供下面echo；

echo $output; // 结尾会多出一个1, 所以CURLOPT_RETURNTRANSFER一般设为1

curl_close($ch); //关闭这个会话资源

```
***

* 发送get请求（默认是get请求,不需要设置）
```php
<?php 
   // create curl resource 
   $ch = curl_init(); //创建了一个curl会话资源，成功返回一个句柄；
   $url = "https://github.com/search?q=react";
   // set url 
   curl_setopt($ch, CURLOPT_URL, $url); //设置url

   //return the transfer as a string 
   curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); //设置是否将相应结果写入变量,0是直接echo出,1是存入 

   // $output contains the output string 
   $output = curl_exec($ch); //执行，然后将响应结果存入$output变量，供下面echo；

   //echo output
   echo $output;  

   // close curl resource to free up system resources 
   curl_close($ch);      //关闭这个会话资源
?>
```

  - 除非是非法和自制的证书,需要避开ssl证书检查的https请求,才会将下面两项设为false,生产环境不建议,这样不安全
  
   `
    CURLOPT_SSL_VERIFYPEER - verify the peer's SSL certificate  
    CURLOPT_SSL_VERIFYHOST - verify the certificate's name against host
   `
   
* 发送post请求

  - 数据为数组形式
```php
<?php 
    // 第一种
    $data=array(
    "name" => "Lei",
    "msg" => "Are you OK?"
    );

    $ch = curl_init(); 
    $url ="http://测试服务器的IP马赛克/testRespond.php";
    curl_setopt($ch, CURLOPT_URL, $url); 
    curl_setopt($ch, CURLOPT_POST, 1);  // 设置为1表明为post请求
    //The number of seconds to wait while trying to connect. Use 0 to wait indefinitely.
    curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 60);  //设置一个最长的可忍受的连接时间，秒为单位
    
    curl_setopt($ch, CURLOPT_POSTFIELDS , http_build_query($data)); //设置POST的数据域，因为这里是数组数据形式的，所以用http_build_query处理一下
    // http_build_query会将数组生成一个经过 URL-encode 的请求字符串
    //此处会把$data处理成name=Lei$msg=Are+you+OK?
    //HTTP请求头的Content-Type会被设置成application/x-www-form-urlencoded,如果是数组的话HTTP请求头的Content-Type会被设置成multipart/form-data
    
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); 

    $output = curl_exec($ch); 

    echo $output;

    curl_close($ch);      

    // 第二种
    // 设置请求地址
    $url ="http://115.29.170.211:8011/sms.aspx";
    // 设置请求数据
    $post_data = array(
        "userid" => 1478,
        "account" => 1099001,
        "password" => 123456,
        "mobile" => 15956551682,
        "content" => '你们好啊【多方技术部】', //内容必须带【】签名
        "action" => 'send',
        "sendTime" => '',
        "extno" => '',
    );

    // 远程post请求
    $curl = curl_init();
    curl_setopt($curl, CURLOPT_URL, $url);
    curl_setopt($curl, CURLOPT_HEADER, 0);
    curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($curl, CURLOPT_POST, 1);
    curl_setopt($curl, CURLOPT_POSTFIELDS, $post_data);
    $data = curl_exec($curl);
    curl_close($curl);

    $data = trim(mb_convert_encoding($data, 'UTF-8', 'GBK'));

    // 解析xml
    $xml = simplexml_load_string($data);
    if ($xml && $xml->returnstatus == 'Success') {
        echo $xml->returnstatus . "\n";
        echo $xml->message . "\n";
        echo $xml->remainpoint . "\n";
        echo $xml->taskID;
        echo $xml->successCounts;
        exit;
    }
    echo '短信发送失败';exit;

?>

```

  - 数据为json形式
  
```php
<?php
    $data = '{"name" : "Lei", "msg" : "Are you OK?"}';
    $ch = curl_init(); 
    $url = "http://测试服务器的IP马赛克/testRespond.php";
    curl_setopt($ch, CURLOPT_URL, $url); 
    curl_setopt($ch, CURLOPT_POST, 1);
    curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 60); 
    curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Content-Length:' . strlen($data)));  // 设置数据类型为json类型
    curl_setopt($ch, CURLOPT_POSTFIELDS , $data);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); 
    
    $output = curl_exec($ch); 

    echo $output;

    curl_close($ch);      
?>

```
***
* curl模拟登陆

```php
<?php
    // 模拟登陆
    function login_post($url, $cookie, $post) {
        $curl = curl_init();//初始化curl模块
        curl_setopt($curl, CURLOPT_URL, $url);//登录提交的地址
        curl_setopt($curl, CURLOPT_HEADER, 0);//是否显示头信息
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 0);//是否自动显示返回的信息
        curl_setopt($curl, CURLOPT_COOKIEJAR, $cookie); //设置Cookie信息保存在指定的文件中
        curl_setopt($curl, CURLOPT_POST, 1);//post方式提交
        curl_setopt($curl, CURLOPT_POSTFIELDS, http_build_query($post));//要提交的信息
        curl_exec($curl);//执行cURL
        curl_close($curl);//关闭cURL资源，并且释放系统资源
    }
    
    // 登录成功后获取数据
    function get_content($url, $cookie) {
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_HEADER, 0);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_COOKIEFILE, $cookie); //读取cookie
        $rs = curl_exec($ch); //执行cURL抓取页面内容
        curl_close($ch);
        return $rs;
    }
    
    // 登录成功后模拟发帖
    function post_thread($url, $cookie, $post)
    {
        $curl = curl_init();//初始化curl模块
        curl_setopt($curl, CURLOPT_URL, $url);//登录提交的地址
        curl_setopt($curl, CURLOPT_HEADER, 0);//是否显示头信息
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 0);//是否自动显示返回的信息
        curl_setopt($curl, CURLOPT_COOKIEFILE, $cookie); //读取cookie
        curl_setopt($curl, CURLOPT_POST, 1);//post方式提交
        curl_setopt($curl, CURLOPT_POSTFIELDS, http_build_query($post));//要提交的信息
        curl_exec($curl);//执行cURL
        curl_close($curl);//关闭cURL资源，并且释放系统资源
    }
    
    
?>

``` 
*** 
* 常用的curl抓取数据时使用的选项

```php

<?php
    curl_setopt($ch, CURLOPT_HEADER, 0);   //是否显示头文件,会将head信息也返回回来
    curl_setopt($ch, CURLOPT_NOBODY,true); //指定了curl抓的内容中包含header头,并且不要body内容
    curl_setopt($ch, CURLOPT_PROXY, '120.9.127.1:6675'); //使用代理
    curl_setopt($ch, CURLOPT_USERAGENT, "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.0)"); //模拟浏览器   
    curl_setopt($ch, CURLOPT_VERBOSE,1); //出错提示

```

* 实例参考

```php
<?php

namespace App\Http\Controllers\Admin;

use Illuminate\Http\Request;
use App\Http\Controllers\Controller;

class CurlController extends Controller
{
    public function index()
    {
        $ch = curl_init();
        $url = "119.29.249.45/test.php";
        $title = '测试curl';
        $number = 1;
        $url .= "?title=" . $title . "&number=" . $number;
        curl_setopt($ch, CURLOPT_URL, $url);  //设置url
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);  //设置是否将相应结果写入变量,0是直接echo出,1是存入 ,一般用1,不需要直接echo,存入变量就可以了
        $output = curl_exec($ch);  //执行，然后将响应结果存入$output变量，供下面echo；
        echo $output;
        curl_close($ch); //关闭这个会话资源
        exit;
    }

    public function post(Request $request)
    {

        $data=array(
            "title" => $request->get('title'),
            "number" => $request->get('number')
        );

        $ch = curl_init();
        $url = "119.29.249.45/test.php";
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_POST, 1);  // 设置为1表明为post请求
        //The number of seconds to wait while trying to connect. Use 0 to wait indefinitely.
        curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 60);  //设置一个最长的可忍受的连接时间，秒为单位

        if ($request->get('json')) {
            // 数据用json提交
            $data['json'] = true;
            $data = json_encode($data);

            curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Content-Length:' . strlen($data)));  // 设置数据类型为json类型
            curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
            // 注意json形式提交的数据, 服务端$postData = file_get_contents('php://input');方式才能接受,$_POST一定是空的
        } else {
            // 数组形式提交
            curl_setopt($ch, CURLOPT_POSTFIELDS , http_build_query($data)); //设置POST的数据域，因为这里是数组数据形式的，所以用http_build_query处理一下
            // http_build_query会将数组生成一个经过 URL-encode 的请求字符串
            //此处会把$data处理成name=Lei$msg=Are+you+OK?
            //HTTP请求头的Content-Type会被设置成application/x-www-form-urlencoded,如果是数组的话HTTP请求头的Content-Type会被设置成multipart/form-data
        }

        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);

        $output = curl_exec($ch);

        echo $output;

        curl_close($ch);

    }

    // 服务端代码
/*<?php
function is_json($string) {
    json_decode($string);
    return (json_last_error() == JSON_ERROR_NONE);
}
$title = isset($_GET['title']) ? $_GET['title'] : 'test_get';
$number = isset($_GET['number']) ? $_GET['number'] : 1;
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $postData = file_get_contents('php://input');

    if (is_json($postData)) {
    $postData = json_decode($postData, true);

    $title = $postData['title'] ? $postData['title'] : 'test_json';
    $number = $postData['number'] ? $postData['number'] : 1;

    } else {
        $title = isset($_POST['title']) ? $_POST['title'] : 'test_post';
        $number = isset($_POST['number']) ? $_POST['number'] : 1;
    }
}
$html = <<<HTML
<!DOCTYPE html>
    <html>
    <head>
    <meta charset="utf-8">
    <title>%s</title>
    </head>
    <body>
        <h1>我的第%d个标题</h1>
        <p>我的第%d个段落。</p>
    </body>
    </html>
HTML;

$html = sprintf($html, $title, $number, $number);
echo $html;*/

}

```





